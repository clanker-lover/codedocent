<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
{% if csrf_token %}<meta name="csrf-token" content="{{ csrf_token }}">{% endif %}
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>codedocent — interactive</title>
<script>
if (localStorage.getItem('cd-theme') === 'light')
    document.documentElement.classList.add('light-mode');
</script>
<style>
:root {
    --bg-body: #1a1a2e;
    --bg-header: #12122a;
    --bg-node: #222240;
    --bg-imports: #1e1e38;
    --bg-pseudocode: #1e2a38;
    --bg-source: #0d0d1a;
    --bg-badge: #2e2e50;
    --bg-btn: #2e2e50;
    --bg-btn-hover: #3a3a5a;
    --bg-btn-active: #4466aa;
    --bg-breadcrumb: #1e1e38;
    --bg-header-hover: #2a2a48;

    --text-primary: #e0e0e0;
    --text-body: #e0e0e0;
    --text-name: #e0e0f0;
    --text-badge: #aaaacc;
    --text-lines: #8888aa;
    --text-range: #8888aa;
    --text-warning: #FFD700;
    --text-imports-label: #8888aa;
    --text-imports-item: #bbbbcc;
    --text-summary: #bbbbcc;
    --text-placeholder: #666688;
    --text-pseudocode-label: #8888aa;
    --text-pseudocode: #ccccdd;
    --text-btn: #bbbbcc;
    --text-link: #7799ee;
    --text-toggle: #8888aa;
    --text-analyzing: #8888aa;
    --text-breadcrumb-sep: #666688;
    --text-breadcrumb-current: #e0e0e0;
    --text-source: #D4D4D4;

    --border-node: #3a3a5a;
    --border-imports: #3a3a5a;
    --border-pseudocode: #3a4a5a;
    --border-btn: #4a4a6a;
    --border-breadcrumb: #3a3a5a;
    --border-textarea: #555;

    --shadow-node: rgba(0, 0, 0, 0.3);
}

:root.light-mode {
    --bg-body: #F5F5F5;
    --bg-header: #1A1A2E;
    --bg-node: #FFFFFF;
    --bg-imports: #F9F9F9;
    --bg-pseudocode: #F0F4F8;
    --bg-source: #1E1E2E;
    --bg-badge: #EEEEEE;
    --bg-btn: #F5F5F5;
    --bg-btn-hover: #E8E8E8;
    --bg-btn-active: #1A1A2E;
    --bg-breadcrumb: #EDEDF0;
    --bg-header-hover: #FAFAFA;

    --text-primary: #333;
    --text-body: #333;
    --text-name: #1A1A2E;
    --text-badge: #666666;
    --text-lines: #888888;
    --text-range: #AAAAAA;
    --text-warning: #B8860B;
    --text-imports-label: #999999;
    --text-imports-item: #555555;
    --text-summary: #555555;
    --text-placeholder: #AAAAAA;
    --text-pseudocode-label: #999999;
    --text-pseudocode: #444444;
    --text-btn: #555;
    --text-link: #5566DD;
    --text-toggle: #888;
    --text-analyzing: #888;
    --text-breadcrumb-sep: #999;
    --text-breadcrumb-current: #333;
    --text-source: #D4D4D4;

    --border-node: #E0E0E0;
    --border-imports: #E8E8E8;
    --border-pseudocode: #D0D8E0;
    --border-btn: #D0D0D0;
    --border-breadcrumb: #D8D8DC;
    --border-textarea: #555;

    --shadow-node: rgba(0, 0, 0, 0.06);
}

*, *::before, *::after {
    box-sizing: border-box;
}

body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg-body);
    color: var(--text-body);
    line-height: 1.5;
}

.cd-header {
    background: var(--bg-header);
    color: #FFFFFF;
    padding: 16px 24px;
    margin-bottom: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.cd-header__title {
    margin: 0;
    font-size: 20px;
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-weight: 700;
}

.cd-header__path {
    margin: 4px 0 0;
    font-size: 13px;
    opacity: 0.7;
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
}

.cd-theme-toggle {
    background: none;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    font-size: 20px;
    cursor: pointer;
    padding: 4px 8px;
    color: #FFF;
    line-height: 1;
}

.cd-theme-toggle:hover {
    border-color: rgba(255,255,255,0.6);
}

.cd-breadcrumb {
    background: var(--bg-breadcrumb);
    border-bottom: 1px solid var(--border-breadcrumb);
    padding: 8px 24px;
    font-size: 13px;
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    margin-bottom: 24px;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
}

.cd-breadcrumb__item {
    color: var(--text-link);
    cursor: pointer;
    text-decoration: none;
}

.cd-breadcrumb__item:hover {
    text-decoration: underline;
}

.cd-breadcrumb__sep {
    color: var(--text-breadcrumb-sep);
    margin: 0 2px;
}

.cd-breadcrumb__current {
    color: var(--text-breadcrumb-current);
    font-weight: 600;
}

.cd-main {
    max-width: 960px;
    margin: 0 auto;
    padding: 0 16px 48px;
}

.cd-node {
    background: var(--bg-node);
    border: 1px solid var(--border-node);
    border-radius: 8px;
    box-shadow: 0 1px 3px var(--shadow-node);
    margin-bottom: 12px;
    border-left-width: 5px;
    border-left-style: solid;
    border-left-color: var(--node-color, #CCCCCC);
}

.cd-node__header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    cursor: pointer;
    user-select: none;
}

.cd-node__header:hover {
    background: var(--bg-header-hover);
}

.cd-node__toggle {
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-size: 12px;
    color: var(--text-toggle);
    width: 16px;
    text-align: center;
    flex-shrink: 0;
}

.cd-node__icon {
    font-size: 16px;
    flex-shrink: 0;
}

.cd-node__name {
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-weight: 700;
    font-size: 14px;
    color: var(--text-name);
}

.cd-node__badge {
    display: inline-block;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 2px 8px;
    border-radius: 10px;
    background: var(--bg-badge);
    color: var(--text-badge);
}

.cd-node__lines {
    font-size: 12px;
    color: var(--text-lines);
}

.cd-node__range {
    font-size: 12px;
    color: var(--text-range);
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
}

.cd-node__quality {
    font-size: 14px;
    flex-shrink: 0;
}

.cd-node__warning-text {
    font-size: 11px;
    color: var(--text-warning);
    font-style: italic;
}

.cd-node__body {
    padding: 0 14px 10px;
    display: none;
}

.cd-node__body--open {
    display: block;
}

.cd-imports {
    background: var(--bg-imports);
    border: 1px solid var(--border-imports);
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 8px;
}

.cd-imports__label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-imports-label);
    cursor: pointer;
    list-style: none;
}

.cd-imports__label::-webkit-details-marker {
    display: none;
}

.cd-imports__label::before {
    content: "▶ ";
    font-size: 9px;
}

.cd-imports[open] > .cd-imports__label::before {
    content: "▼ ";
}

.cd-imports__item {
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-size: 13px;
    color: var(--text-imports-item);
    padding: 1px 0;
}

.cd-summary {
    color: var(--text-summary);
    font-size: 13px;
    margin-bottom: 8px;
}

.cd-analyze-link {
    color: var(--text-link);
    cursor: pointer;
    font-size: 13px;
    font-style: italic;
    margin-bottom: 8px;
}

.cd-analyze-link:hover {
    text-decoration: underline;
}

.cd-analyzing {
    color: var(--text-analyzing);
    font-size: 13px;
    font-style: italic;
    margin-bottom: 8px;
    animation: cd-pulse 1.5s ease-in-out infinite;
}

@keyframes cd-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

.cd-pseudocode {
    background: var(--bg-pseudocode);
    border: 1px solid var(--border-pseudocode);
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 8px;
}

.cd-pseudocode__label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-pseudocode-label);
    margin-bottom: 4px;
}

.cd-pseudocode__code {
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-size: 13px;
    color: var(--text-pseudocode);
    margin: 0;
    white-space: pre-wrap;
}

.cd-warnings {
    margin-bottom: 8px;
}

.cd-warnings__item {
    font-size: 13px;
    color: var(--text-warning);
    padding: 2px 0;
}

.cd-node__children {
    padding-left: 16px;
}

.cd-code-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 8px;
}

.cd-code-btn {
    font-size: 12px;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 14px;
    border: 1px solid var(--border-btn);
    background: var(--bg-btn);
    color: var(--text-btn);
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
}

.cd-code-btn:hover {
    background: var(--bg-btn-hover);
}

.cd-code-btn--active {
    background: var(--bg-btn-active);
    color: #FFF;
    border-color: var(--bg-btn-active);
}

.cd-code-btn--copied {
    background: #2E7D32;
    color: #FFF;
    border-color: #2E7D32;
}

.cd-source-display {
    display: none;
    background: var(--bg-source);
    color: var(--text-source);
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 8px;
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-size: 13px;
    overflow-x: auto;
    white-space: pre;
    line-height: 1.5;
    margin-top: 0;
}

.cd-source-display--open {
    display: block;
}

@media (max-width: 600px) {
    .cd-header {
        padding: 12px 12px;
    }
    .cd-breadcrumb {
        padding: 8px 12px;
    }
    .cd-main {
        padding: 0 8px 32px;
    }
    .cd-node__header {
        padding: 8px 10px;
    }
    .cd-node__body {
        padding: 0 10px 8px;
    }
    .cd-node__children {
        padding-left: 8px;
    }
}

.cd-replace-panel {
    margin-bottom: 8px;
}
.cd-replace-panel textarea {
    width: 100%;
    min-height: 120px;
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-size: 13px;
    background: var(--bg-source);
    color: var(--text-source);
    border: 1px solid var(--border-textarea);
    border-radius: 6px;
    padding: 12px;
    line-height: 1.5;
    resize: vertical;
    box-sizing: border-box;
}
.cd-replace-panel__btns {
    display: flex;
    gap: 6px;
    margin-top: 6px;
}
.cd-replace-msg {
    font-size: 12px;
    margin-top: 4px;
    padding: 4px 8px;
    border-radius: 4px;
}
.cd-replace-msg--ok {
    background: #2E7D32;
    color: #FFF;
}
.cd-replace-msg--err {
    background: #C62828;
    color: #FFF;
}
</style>
</head>
<body>

<header class="cd-header">
    <div class="cd-header__text">
        <h1 class="cd-header__title">codedocent</h1>
        <p class="cd-header__path" id="cd-root-path"></p>
    </div>
    <button class="cd-theme-toggle" id="cd-theme-toggle"
            onclick="cdToggleTheme()" aria-label="Toggle theme"></button>
</header>

<nav class="cd-breadcrumb" id="cd-breadcrumb">
    <span class="cd-breadcrumb__current" id="cd-bc-root"></span>
</nav>

<main class="cd-main" id="cd-main"></main>

<script>
function cdToggleTheme() {
    var isLight = document.documentElement.classList.toggle('light-mode');
    localStorage.setItem('cd-theme', isLight ? 'light' : 'dark');
    document.getElementById('cd-theme-toggle').textContent = isLight ? '\u{1F319}' : '\u2600\uFE0F';
}
(function() {
    var btn = document.getElementById('cd-theme-toggle');
    if (btn) btn.textContent = document.documentElement.classList.contains('light-mode') ? '\u{1F319}' : '\u2600\uFE0F';
})();

const TREE_DATA = {{ tree_json | safe }};
const CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// Track expanded path for breadcrumbs
let breadcrumbPath = [TREE_DATA];

function escapeHtml(s) {
    if (!s) return '';
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function qualityEmoji(q) {
    if (q === 'warning') return '\u{1F534}';
    if (q === 'complex') return '\u{1F7E1}';
    return '\u{1F7E2}';
}

var sourceCache = {};

function cdFetchSource(nodeId, callback) {
    if (sourceCache[nodeId]) {
        callback(sourceCache[nodeId]);
        return;
    }
    fetch('/api/source/' + nodeId, {
        headers: {'X-Codedocent-Token': CSRF_TOKEN}
    })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.source) {
                sourceCache[nodeId] = data.source;
            }
            callback(data.source || '');
        })
        .catch(function() { callback(''); });
}

function cdToggleSource(btn, pre) {
    var isOpen = pre.classList.contains('cd-source-display--open');
    if (isOpen) {
        pre.classList.remove('cd-source-display--open');
        btn.classList.remove('cd-code-btn--active');
        btn.textContent = 'Show Code';
    } else {
        pre.classList.add('cd-source-display--open');
        btn.classList.add('cd-code-btn--active');
        btn.textContent = 'Hide Code';
    }
}

function cdCopyToClipboard(text, btn) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
            cdShowCopied(btn);
        }, function() {
            cdFallbackCopy(text, btn);
        });
    } else {
        cdFallbackCopy(text, btn);
    }
}

function cdFallbackCopy(text, btn) {
    var ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); cdShowCopied(btn); }
    catch(e) {}
    document.body.removeChild(ta);
}

function cdShowCopied(btn) {
    var orig = btn.textContent;
    btn.textContent = 'Copied!';
    btn.classList.add('cd-code-btn--copied');
    setTimeout(function() {
        btn.textContent = orig;
        btn.classList.remove('cd-code-btn--copied');
    }, 1500);
}

function cdCreateCodeActions(bodyEl, nodeId, nodeType, nodeName, filepath, language) {
    if (bodyEl.querySelector('.cd-code-actions')) return;

    var pre = document.createElement('pre');
    pre.className = 'cd-source-display';

    function ensureSource(callback) {
        if (pre.dataset.loaded === 'true') {
            callback(pre.textContent);
            return;
        }
        cdFetchSource(nodeId, function(source) {
            pre.textContent = source;
            pre.dataset.loaded = 'true';
            callback(source);
        });
    }

    var actions = document.createElement('div');
    actions.className = 'cd-code-actions';

    var btnShow = document.createElement('button');
    btnShow.className = 'cd-code-btn';
    btnShow.textContent = 'Show Code';
    btnShow.addEventListener('click', function(e) {
        e.stopPropagation();
        ensureSource(function() {
            cdToggleSource(btnShow, pre);
        });
    });
    actions.appendChild(btnShow);

    var btnExport = document.createElement('button');
    btnExport.className = 'cd-code-btn';
    btnExport.textContent = 'Export Code';
    btnExport.addEventListener('click', function(e) {
        e.stopPropagation();
        ensureSource(function(source) {
            cdCopyToClipboard(source, btnExport);
        });
    });
    actions.appendChild(btnExport);

    var btnAI = document.createElement('button');
    btnAI.className = 'cd-code-btn';
    btnAI.textContent = 'Copy for AI';
    btnAI.addEventListener('click', function(e) {
        e.stopPropagation();
        ensureSource(function(source) {
            var lang = language || '';
            var text = 'This is the ' + nodeType + ' `' + nodeName + '` from `' + (filepath || '') + '`:\n\n```' + lang + '\n' + source + '\n```';
            cdCopyToClipboard(text, btnAI);
        });
    });
    actions.appendChild(btnAI);

    if (nodeType === 'function' || nodeType === 'method' || nodeType === 'class') {
        var btnReplace = document.createElement('button');
        btnReplace.className = 'cd-code-btn';
        btnReplace.textContent = 'Replace Code';
        btnReplace.addEventListener('click', function(e) {
            e.stopPropagation();
            ensureSource(function(source) {
                cdShowReplacePanel(bodyEl, nodeId, source, pre, btnShow);
            });
        });
        actions.appendChild(btnReplace);
    }

    var childrenEl = bodyEl.querySelector('.cd-node__children');
    if (childrenEl) {
        bodyEl.insertBefore(actions, childrenEl);
        bodyEl.insertBefore(pre, childrenEl);
    } else {
        bodyEl.appendChild(actions);
        bodyEl.appendChild(pre);
    }
}

function cdShowReplacePanel(bodyEl, nodeId, currentSource, pre, btnShow) {
    // Remove existing panel if any
    var existing = bodyEl.querySelector('.cd-replace-panel');
    if (existing) { existing.remove(); return; }

    var panel = document.createElement('div');
    panel.className = 'cd-replace-panel';

    var ta = document.createElement('textarea');
    ta.value = currentSource;
    ta.addEventListener('click', function(e) { e.stopPropagation(); });
    panel.appendChild(ta);

    var btns = document.createElement('div');
    btns.className = 'cd-replace-panel__btns';

    var btnConfirm = document.createElement('button');
    btnConfirm.className = 'cd-code-btn';
    btnConfirm.textContent = 'Confirm Replace';
    btnConfirm.addEventListener('click', function(e) {
        e.stopPropagation();
        btnConfirm.disabled = true;
        btnConfirm.textContent = 'Replacing...';
        fetch('/api/replace/' + nodeId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-Codedocent-Token': CSRF_TOKEN},
            body: JSON.stringify({source: ta.value})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                // Update source display and cache
                pre.textContent = ta.value;
                pre.dataset.loaded = 'true';
                delete sourceCache[nodeId];
                // Show success message
                var msg = document.createElement('div');
                msg.className = 'cd-replace-msg cd-replace-msg--ok';
                msg.textContent = 'Replaced! (' + data.lines_before
                    + ' \u2192 ' + data.lines_after + ' lines)';
                panel.appendChild(msg);
                setTimeout(function() { panel.remove(); }, 2000);
            } else {
                var msg = document.createElement('div');
                msg.className = 'cd-replace-msg cd-replace-msg--err';
                msg.textContent = 'Error: ' + data.error;
                panel.appendChild(msg);
                btnConfirm.disabled = false;
                btnConfirm.textContent = 'Confirm Replace';
            }
        })
        .catch(function(err) {
            var msg = document.createElement('div');
            msg.className = 'cd-replace-msg cd-replace-msg--err';
            msg.textContent = 'Network error';
            panel.appendChild(msg);
            btnConfirm.disabled = false;
            btnConfirm.textContent = 'Confirm Replace';
        });
    });
    btns.appendChild(btnConfirm);

    var btnCancel = document.createElement('button');
    btnCancel.className = 'cd-code-btn';
    btnCancel.textContent = 'Cancel';
    btnCancel.addEventListener('click', function(e) {
        e.stopPropagation();
        panel.remove();
    });
    btns.appendChild(btnCancel);

    panel.appendChild(btns);

    // Insert panel after the actions bar
    var actionsEl = bodyEl.querySelector('.cd-code-actions');
    if (actionsEl && actionsEl.nextSibling) {
        bodyEl.insertBefore(panel, actionsEl.nextSibling);
    } else {
        bodyEl.appendChild(panel);
    }
}

function renderNode(node, depth) {
    const el = document.createElement('div');
    el.className = 'cd-node';
    el.style.setProperty('--node-color', node.color || '#CCCCCC');
    el.dataset.nodeId = node.node_id || '';

    const isRoot = depth === 0;
    const hasChildren = node.children && node.children.length > 0;
    const isDir = node.node_type === 'directory';

    // Header
    const header = document.createElement('div');
    header.className = 'cd-node__header';

    // Toggle indicator
    const toggle = document.createElement('span');
    toggle.className = 'cd-node__toggle';
    if (hasChildren) {
        toggle.textContent = isRoot ? 'v' : '>';
    }
    header.appendChild(toggle);

    const icon = document.createElement('span');
    icon.className = 'cd-node__icon';
    icon.textContent = node.icon || '';
    header.appendChild(icon);

    const name = document.createElement('span');
    name.className = 'cd-node__name';
    name.textContent = node.name;
    header.appendChild(name);

    const badge = document.createElement('span');
    badge.className = 'cd-node__badge';
    badge.textContent = node.node_type;
    header.appendChild(badge);

    const lines = document.createElement('span');
    lines.className = 'cd-node__lines';
    lines.textContent = node.line_count + ' lines';
    header.appendChild(lines);

    if ((node.node_type === 'function' || node.node_type === 'method') && node.start_line && node.end_line) {
        const range = document.createElement('span');
        range.className = 'cd-node__range';
        range.textContent = 'L' + node.start_line + '\u2013' + node.end_line;
        header.appendChild(range);
    }

    const quality = document.createElement('span');
    quality.className = 'cd-node__quality';
    quality.textContent = qualityEmoji(node.quality);
    header.appendChild(quality);

    if (node.warnings && node.warnings.length > 0) {
        const warningText = document.createElement('span');
        warningText.className = 'cd-node__warning-text';
        warningText.textContent = node.warnings.join('; ');
        header.appendChild(warningText);
    }

    el.appendChild(header);

    // Body
    const body = document.createElement('div');
    body.className = 'cd-node__body' + (isRoot ? ' cd-node__body--open' : '');

    // Imports
    if (node.imports && node.imports.length > 0) {
        const imp = document.createElement('details');
        imp.className = 'cd-imports';
        imp.innerHTML = '<summary class="cd-imports__label">IMPORTS (' + node.imports.length + ')</summary>' +
            node.imports.map(i => '<div class="cd-imports__item">\u2192 ' + escapeHtml(i) + '</div>').join('');
        body.appendChild(imp);
    }

    // Summary / analyze link
    const summaryEl = document.createElement('div');
    if (node.summary) {
        summaryEl.className = 'cd-summary';
        summaryEl.textContent = node.summary;
        body.appendChild(summaryEl);
    } else if (!isDir && node.node_id) {
        summaryEl.className = 'cd-analyze-link';
        summaryEl.textContent = 'Click to analyze with AI...';
        summaryEl.dataset.nodeId = node.node_id;
        summaryEl.addEventListener('click', function(e) {
            e.stopPropagation();
            analyzeNode(node.node_id, summaryEl, body);
        });
        body.appendChild(summaryEl);
    }

    // Pseudocode
    if (node.pseudocode && (node.node_type === 'function' || node.node_type === 'method')) {
        const pc = document.createElement('div');
        pc.className = 'cd-pseudocode';
        pc.innerHTML = '<div class="cd-pseudocode__label">PSEUDOCODE</div>' +
            '<pre class="cd-pseudocode__code">' + escapeHtml(node.pseudocode) + '</pre>';
        body.appendChild(pc);
    }

    // Warnings
    if (node.warnings && node.warnings.length > 0) {
        const w = document.createElement('div');
        w.className = 'cd-warnings';
        w.innerHTML = node.warnings.map(
            warn => '<div class="cd-warnings__item">\u26A0\uFE0F ' + escapeHtml(warn) + '</div>'
        ).join('');
        body.appendChild(w);
    }

    // Code export buttons (for pre-analyzed nodes with summaries at load time)
    if (!isDir && node.node_id) {
        cdCreateCodeActions(body, node.node_id, node.node_type, node.name, node.filepath, node.language);
    }

    // Children
    if (hasChildren) {
        const childrenEl = document.createElement('div');
        childrenEl.className = 'cd-node__children';
        node.children.forEach(function(child) {
            childrenEl.appendChild(renderNode(child, depth + 1));
        });
        body.appendChild(childrenEl);
    }

    el.appendChild(body);

    // Click handler for expand/collapse
    header.addEventListener('click', function() {
        const isOpen = body.classList.contains('cd-node__body--open');
        if (isOpen) {
            body.classList.remove('cd-node__body--open');
            toggle.textContent = hasChildren ? '>' : '';
        } else {
            body.classList.add('cd-node__body--open');
            toggle.textContent = hasChildren ? 'v' : '';
            updateBreadcrumb(node, el);
        }
    });

    return el;
}

function updateBreadcrumb(node, el) {
    // Build path from root to this node by walking up DOM
    const path = [];
    let current = el;
    while (current) {
        if (current.dataset && current.dataset.nodeId) {
            const name = current.querySelector('.cd-node__name');
            if (name) {
                path.unshift({name: name.textContent, el: current});
            }
        }
        current = current.parentElement ? current.parentElement.closest('.cd-node') : null;
    }

    const bc = document.getElementById('cd-breadcrumb');
    bc.innerHTML = '';

    path.forEach(function(item, i) {
        if (i > 0) {
            const sep = document.createElement('span');
            sep.className = 'cd-breadcrumb__sep';
            sep.textContent = '/';
            bc.appendChild(sep);
        }
        if (i < path.length - 1) {
            const link = document.createElement('span');
            link.className = 'cd-breadcrumb__item';
            link.textContent = item.name;
            link.addEventListener('click', function() {
                item.el.scrollIntoView({behavior: 'smooth', block: 'start'});
            });
            bc.appendChild(link);
        } else {
            const cur = document.createElement('span');
            cur.className = 'cd-breadcrumb__current';
            cur.textContent = item.name;
            bc.appendChild(cur);
        }
    });
}

function analyzeNode(nodeId, linkEl, bodyEl) {
    // Replace link with loading indicator
    const loading = document.createElement('div');
    loading.className = 'cd-analyzing';
    loading.textContent = 'Analyzing...';
    linkEl.replaceWith(loading);

    fetch('/api/analyze/' + nodeId, {
        method: 'POST',
        headers: {'X-Codedocent-Token': CSRF_TOKEN}
    })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            // Replace loading with summary
            if (data.summary) {
                const summary = document.createElement('div');
                summary.className = 'cd-summary';
                summary.textContent = data.summary;
                loading.replaceWith(summary);

                // Add pseudocode if present
                if (data.pseudocode && (data.node_type === 'function' || data.node_type === 'method')) {
                    const pc = document.createElement('div');
                    pc.className = 'cd-pseudocode';
                    pc.innerHTML = '<div class="cd-pseudocode__label">PSEUDOCODE</div>' +
                        '<pre class="cd-pseudocode__code">' + escapeHtml(data.pseudocode) + '</pre>';
                    summary.after(pc);
                }

                // Add warnings if present
                if (data.warnings && data.warnings.length > 0) {
                    const w = document.createElement('div');
                    w.className = 'cd-warnings';
                    w.innerHTML = data.warnings.map(
                        function(warn) { return '<div class="cd-warnings__item">\u26A0\uFE0F ' + escapeHtml(warn) + '</div>'; }
                    ).join('');
                    bodyEl.appendChild(w);
                }

                // Update quality indicator
                if (data.quality) {
                    const nodeEl = bodyEl.closest('.cd-node');
                    const qEl = nodeEl.querySelector('.cd-node__quality');
                    if (qEl) qEl.textContent = qualityEmoji(data.quality);
                }

                // Update inline warning text
                if (data.warnings && data.warnings.length > 0) {
                    const nodeEl = bodyEl.closest('.cd-node');
                    let wt = nodeEl.querySelector('.cd-node__warning-text');
                    if (!wt) {
                        wt = document.createElement('span');
                        wt.className = 'cd-node__warning-text';
                        nodeEl.querySelector('.cd-node__header').appendChild(wt);
                    }
                    wt.textContent = data.warnings.join('; ');
                }

                // Add code export buttons
                if (data.source) {
                    sourceCache[nodeId] = data.source;
                    cdCreateCodeActions(bodyEl, nodeId, data.node_type, data.name, data.filepath, data.language);
                }
            } else {
                loading.textContent = 'No summary available';
                loading.className = 'cd-summary';
            }
        })
        .catch(function(err) {
            loading.textContent = 'Analysis failed: ' + err.message;
            loading.className = 'cd-summary';
        });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('cd-root-path').textContent = TREE_DATA.filepath || TREE_DATA.name;
    document.getElementById('cd-bc-root').textContent = TREE_DATA.name;
    document.getElementById('cd-main').appendChild(renderNode(TREE_DATA, 0));
});

// Shutdown on tab close
window.addEventListener('beforeunload', function() {
    fetch('/shutdown', {
        method: 'POST',
        headers: {'X-Codedocent-Token': CSRF_TOKEN},
        keepalive: true
    });
});
</script>

</body>
</html>
